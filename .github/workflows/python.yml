name: build python
on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 1 * *"
  push:
    branches:
      - master
    paths:
      - python/**

permissions:
  contents: read

jobs:
  build:
    name: "yolks:python_${{ matrix.tag }}"
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        tag:
          - "3.10"
          - "3.11"
          - "3.12"
          - "3.13"
    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-qemu-action@v3

      - uses: chainguard-dev/actions/setup-melange@main

      - name: Generate signing keys
        working-directory: python
        run: melange keygen

      - name: Build entrypoint package
        working-directory: python
        run: |
          melange build entrypoint/melange.yaml \
            --source-dir . \
            --signing-key melange.rsa

      - name: Build image
        run: |
          docker run --rm \
            -v ${{ github.workspace }}/python:/work \
            ghcr.io/wolfi-dev/sdk:latest \
            apko build \
              /work/${{ matrix.tag }}/apko.yaml \
              python-${{ matrix.tag }}:latest \
              /work/python-${{ matrix.tag }}.tar \
              --keyring-append /work/melange.rsa.pub \
              --repository-append /work/packages
